services:
  # 1. Database
  db:
    image: postgres:17-alpine
    container_name: english-db-test
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "5433:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 2. Redis
  redis:
    image: redis:7-alpine
    container_name: english-app-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data

  # 3. Backend
  app:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: english-app-test
    ports:
      - "8980:8980"
      - "5005:5005"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    environment:
      # ===== SPRING PROFILE =====
      SPRING_PROFILES_ACTIVE: docker
      
      # ===== DATABASE =====
      SPRING_DATASOURCE_URL: jdbc:postgresql://db:5432/${POSTGRES_DB}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
      
      # ===== REDIS =====
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      
      # ===== EMAIL =====
      SPRING_MAIL_HOST: smtp.gmail.com
      SPRING_MAIL_PORT: 587
      SPRING_MAIL_USERNAME: ${SPRING_MAIL_USERNAME}
      SPRING_MAIL_PASSWORD: ${SPRING_MAIL_PASSWORD}
      
      # ===== JWT =====
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-86400000}
      
      # ===== AI API =====
      AI_GEMINI_API_KEY: ${AI_GEMINI_API_KEY}
      AI_GROQ_API_KEY: ${AI_GROQ_API_KEY}
      
      # ===== APP CONFIG =====
      APP_NAME: "English Learning App"
      APP_FRONTEND_URL: http://localhost:5173
      
      # ===== JPA =====
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: "false"
      
      # ===== DEVTOOLS =====
      SPRING_DEVTOOLS_RESTART_ENABLED: "true"
      SPRING_DEVTOOLS_LIVERELOAD_ENABLED: "true"
      
      # ===== LOGGING =====
      LOG_LEVEL_APP: INFO
      LOG_LEVEL_SECURITY: INFO
      LOG_LEVEL_MAIL: DEBUG
      LOG_LEVEL_JAKARTA_MAIL: DEBUG

      # ===== CLEANUP CONFIG =====
      CLEANUP_ENABLED: "true"
      CLEANUP_HOURS: 24
      CLEANUP_CRON: "0 0 2 * * *"
      
    volumes:
      - ./backend/src:/workspace/src
      - ./backend/pom.xml:/workspace/pom.xml
      - ./backend/target:/workspace/target
      - maven-repo:/root/.m2
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8980/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # 4. Frontend
  frontend:
    build:
      context: ./frontend-vue
      dockerfile: Dockerfile
    container_name: english-app-frontend
    ports:
      - "5173:5173"
    volumes:
      - ./frontend-vue:/app
      - /app/node_modules
    environment:
      VITE_API_PROXY_TARGET: http://app:8980
    depends_on:
      - app

volumes:
  postgres-data:
  redis-data:
  maven-repo: